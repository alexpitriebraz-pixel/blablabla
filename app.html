<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlaBlaBla</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase Compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth-compat.js"></script>
  <!-- Socket.IO Client -->
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.2/dist/socket.io.min.js"></script>

  <style>
    /* â”€â”€â”€ Reset â”€â”€â”€ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    /* â”€â”€â”€ Base â”€â”€â”€ */
    body {
      font-family: 'Inter', sans-serif;
      background: #08090f;
      color: #fff;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Screens â”€â”€â”€ */
    .screen { display: none; min-height: 100vh; }
    .screen.active { display: flex; flex-direction: column; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOGIN
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-login {
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }
    #screen-login::before {
      content: '';
      position: absolute;
      top: -200px; left: -200px;
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(124,58,237,0.15) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }
    #screen-login::after {
      content: '';
      position: absolute;
      bottom: -200px; right: -200px;
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(236,72,153,0.15) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }
    .login-content { position: relative; z-index: 1; }

    .login-logo { width: 72px; height: 72px; margin: 0 auto 28px; display: block; }

    .login-title {
      font-size: 2.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    .login-subtitle {
      color: rgba(255,255,255,0.45);
      font-size: 1rem;
      margin-bottom: 44px;
    }
    .login-buttons { display: flex; flex-direction: column; gap: 12px; align-items: center; }

    /* Email login form */
    .email-form { display: flex; flex-direction: column; gap: 10px; width: 280px; }
    .email-form input {
      width: 100%; padding: 13px 16px;
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
      background: rgba(255,255,255,0.04); color: white;
      font-size: 15px; font-family: 'Inter', sans-serif;
      outline: none; box-sizing: border-box;
    }
    .email-form input::placeholder { color: rgba(255,255,255,0.35); }
    .email-form input:focus { border-color: rgba(124,58,237,0.6); }
    .email-form-btns { display: flex; gap: 8px; }
    .email-form-btns button {
      flex: 1; padding: 13px; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 600; cursor: pointer;
      font-family: 'Inter', sans-serif; transition: all 0.2s;
    }
    .email-btn-login {
      background: linear-gradient(135deg, #7c3aed, #a855f7); color: white;
    }
    .email-btn-login:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(124,58,237,0.3); }
    .email-btn-register {
      background: transparent; color: #a855f7;
      border: 1px solid rgba(124,58,237,0.5) !important;
    }
    .email-btn-register:hover { background: rgba(124,58,237,0.1); }
    .login-divider {
      display: flex; align-items: center; gap: 12px;
      width: 280px; margin: 4px 0; color: rgba(255,255,255,0.35); font-size: 13px;
    }
    .login-divider::before, .login-divider::after {
      content: ''; flex: 1; height: 1px; background: rgba(255,255,255,0.1);
    }

    .login-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      width: 280px;
      padding: 14px 24px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      color: white;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }
    .login-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(124,58,237,0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(124,58,237,0.2);
    }
    .login-btn svg { width: 22px; height: 22px; flex-shrink: 0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HOME
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-home { align-items: center; justify-content: center; padding: 2rem; }

    .top-bar {
      position: absolute;
      top: 0; left: 0; right: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px;
      background: rgba(8,9,15,0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .user-avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(124,58,237,0.5);
    }
    .user-name { font-size: 14px; font-weight: 500; }

    .btn-ghost {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.65);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.1); color: white; }

    .home-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 400px;
    }
    .home-title {
      text-align: center;
      font-size: 1.9rem;
      font-weight: 700;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 4px;
    }

    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 22px;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: rgba(124,58,237,0.25); }
    .card h3 { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
    .card p  { font-size: 13px; color: rgba(255,255,255,0.45); margin-bottom: 16px; }

    .btn-primary {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }

    .input-row { display: flex; gap: 10px; }
    .input-row input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      color: white;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: border-color 0.2s;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .input-row input:focus { border-color: rgba(124,58,237,0.5); }
    .input-row input::placeholder { color: rgba(255,255,255,0.28); letter-spacing: 1px; }
    .input-row button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .input-row button:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(124,58,237,0.3); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ROOM
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .room-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: rgba(8,9,15,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      flex-shrink: 0;
    }
    .room-header-left { display: flex; align-items: center; gap: 14px; }
    .room-code-badge {
      padding: 5px 14px;
      background: linear-gradient(135deg, rgba(124,58,237,0.18), rgba(236,72,153,0.18));
      border: 1px solid rgba(124,58,237,0.3);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 3px;
    }
    .room-members-count { font-size: 13px; color: rgba(255,255,255,0.45); }

    .btn-leave {
      padding: 7px 16px;
      border: 1px solid rgba(236,72,153,0.3);
      border-radius: 8px;
      background: rgba(236,72,153,0.08);
      color: #ec4899;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-leave:hover { background: rgba(236,72,153,0.18); }

    .room-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }

    /* Player */
    .player-wrapper {
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      background: #000;
    }
    .player-wrapper > div { width: 100% !important; height: 100% !important; }
    .player-wrapper iframe { width: 100% !important; height: 100% !important; border-radius: 12px; }
    .player-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
    }
    .no-track-placeholder {
      position: absolute; inset: 0; z-index: 3;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: rgba(10,10,15,0.95); border-radius: 12px; gap: 10px; pointer-events: none;
    }
    .no-track-placeholder span:first-child { font-size: 2.5rem; }
    .no-track-placeholder span:last-child { color: rgba(255,255,255,0.35); font-size: 0.85rem; }

    /* Now playing */
    .now-playing { width: 100%; max-width: 800px; text-align: center; min-height: 40px; }
    .now-playing .waiting-msg { color: rgba(255,255,255,0.35); font-size: 14px; font-style: italic; }
    .now-playing .track-name  { font-size: 16px; font-weight: 600; }
    .now-playing .track-artist { font-size: 13px; color: rgba(255,255,255,0.45); margin-top: 2px; }

    /* Controls bar */
    .controls-bar {
      width: 100%;
      max-width: 800px;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
    }
    .play-pause-btn {
      width: 42px; height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .play-pause-btn:hover { transform: scale(1.08); box-shadow: 0 4px 16px rgba(124,58,237,0.4); }

    .seekbar-section { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .time-row { display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.35); }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.15);
      outline: none;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px; height: 14px;
      border-radius: 50%;
      background: #7c3aed;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(124,58,237,0.5);
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; height: 14px;
      border-radius: 50%;
      background: #7c3aed;
      cursor: pointer;
      border: none;
    }

    /* Volume */
    .volume-row {
      width: 100%;
      max-width: 800px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .volume-row .vol-icon { font-size: 18px; flex-shrink: 0; }
    .volume-row input[type="range"] { max-width: 130px; }

    /* Search */
    .search-section { width: 100%; max-width: 800px; }
    .search-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: rgba(255,255,255,0.75); }
    .search-row { display: flex; gap: 10px; margin-bottom: 14px; }
    .search-row input {
      flex: 1;
      padding: 11px 16px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      color: white;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      outline: none;
    }
    .search-row input:focus { border-color: rgba(124,58,237,0.5); }
    .search-row input::placeholder { color: rgba(255,255,255,0.28); }
    .search-row button {
      padding: 11px 20px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .search-row button:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(124,58,237,0.3); }

    .search-results { display: flex; flex-direction: column; gap: 6px; max-height: 320px; overflow-y: auto; }
    .search-results::-webkit-scrollbar { width: 6px; }
    .search-results::-webkit-scrollbar-track { background: transparent; }
    .search-results::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 3px; }

    .video-card {
      display: flex;
      gap: 12px;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.18s;
    }
    .video-card:hover { background: rgba(124,58,237,0.1); border-color: rgba(124,58,237,0.2); }
    .video-card img { width: 160px; height: 90px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
    .video-info { display: flex; flex-direction: column; justify-content: center; min-width: 0; }
    .video-title {
      font-size: 14px; font-weight: 500; line-height: 1.35;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .video-channel { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 4px; }

    /* Members */
    .members-row { width: 100%; max-width: 800px; display: flex; flex-wrap: wrap; gap: 6px; }
    .member-badge {
      padding: 5px 11px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 18px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }
    .member-badge.is-host { border-color: rgba(124,58,237,0.4); background: rgba(124,58,237,0.14); color: #a78bfa; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 11px 22px;
      background: rgba(24,24,32,0.95);
      border: 1px solid rgba(236,72,153,0.3);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: transform 0.3s ease;
      z-index: 200;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Autoplay gate */
    .autoplay-gate {
      position: fixed;
      inset: 0;
      background: rgba(8,9,15,0.92);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 18px;
      z-index: 100;
      text-align: center;
      padding: 2rem;
    }
    .autoplay-gate.show { display: flex; }
    .autoplay-gate h2 { font-size: 1.4rem; }
    .autoplay-gate p  { color: rgba(255,255,255,0.5); font-size: 15px; max-width: 320px; }
    .autoplay-gate button {
      padding: 13px 32px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #7c3aed, #ec4899);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .video-card img { width: 110px; height: 62px; }
      .room-body { padding: 16px 12px; }
      .login-title { font-size: 2.2rem; }
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen active">
  <div class="login-content">
    <svg class="login-logo" viewBox="0 0 72 72" fill="none">
      <rect width="72" height="72" rx="18" fill="url(#lg1)"/>
      <defs>
        <linearGradient id="lg1" x1="0" y1="0" x2="72" y2="72">
          <stop offset="0%" stop-color="#7c3aed"/>
          <stop offset="100%" stop-color="#ec4899"/>
        </linearGradient>
      </defs>
      <rect x="18" y="28" width="5" height="16" rx="2.5" fill="white" opacity="0.55"/>
      <rect x="27" y="20" width="5" height="24" rx="2.5" fill="white" opacity="0.9"/>
      <rect x="36" y="24" width="5" height="20" rx="2.5" fill="white" opacity="0.7"/>
      <rect x="45" y="30" width="5" height="14" rx="2.5" fill="white" opacity="0.5"/>
    </svg>

    <h1 class="login-title">BlaBlaBla</h1>
    <p class="login-subtitle" data-i18n="login_subtitle">Listen together, anywhere</p>

    <div class="login-buttons">
      <div class="email-form">
        <input type="email" id="email-input" data-i18n-placeholder="email_placeholder" placeholder="Email" autocomplete="email">
        <input type="password" id="password-input" data-i18n-placeholder="password_placeholder" placeholder="Password" autocomplete="current-password">
        <div class="email-form-btns">
          <button class="email-btn-login" onclick="emailLogin()" data-i18n="email_login">Sign In</button>
          <button class="email-btn-register" onclick="emailRegister()" data-i18n="email_register">Register</button>
        </div>
      </div>

      <div class="login-divider" data-i18n="or_divider">or</div>

      <button class="login-btn" onclick="loginWith('google')">
        <svg viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span data-i18n="login_google">Sign in with Google</span>
      </button>

      <button class="login-btn" onclick="loginWith('facebook')">
        <svg viewBox="0 0 24 24">
          <path fill="#1877F2" d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
        </svg>
        <span data-i18n="login_facebook">Sign in with Facebook</span>
      </button>

      <button class="login-btn" onclick="loginWith('apple')">
        <svg viewBox="0 0 24 24" fill="white">
          <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.8-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
        </svg>
        <span data-i18n="login_apple">Sign in with Apple</span>
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-home" class="screen">
  <div class="top-bar">
    <div class="user-info">
      <img class="user-avatar" id="user-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36'/%3E" alt="">
      <span class="user-name" id="user-name">User</span>
    </div>
    <button class="btn-ghost" onclick="logout()" data-i18n="logout">Logout</button>
  </div>

  <div class="home-content">
    <h2 class="home-title">BlaBlaBla</h2>

    <div class="card">
      <h3 data-i18n="create_room_title">ğŸµ Create Room</h3>
      <p data-i18n="create_room_desc">Create a room and share the code with your friends.</p>
      <button class="btn-primary" onclick="createRoom()" data-i18n="create_room_btn">Create New Room</button>
    </div>

    <div class="card">
      <h3 data-i18n="join_room_title">ğŸ§ Join Room</h3>
      <p data-i18n="join_room_desc">Enter the 6-character code shared by a friend.</p>
      <div class="input-row">
        <input type="text" id="input-room-code" data-i18n-placeholder="room_code_placeholder" placeholder="Ex: AB12CD" maxlength="6"
               onkeypress="if(event.key==='Enter') joinRoom()">
        <button onclick="joinRoom()" data-i18n="join_btn">Join</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ROOM
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-room" class="screen">
  <div class="room-header">
    <div class="room-header-left">
      <span class="room-code-badge" id="room-code">------</span>
      <span class="room-members-count" id="member-count">0</span>
    </div>
    <button class="btn-leave" onclick="leaveRoom()" data-i18n="leave_btn">â†© Leave</button>
  </div>

  <div class="room-body">
    <!-- Player -->
    <div class="player-wrapper">
      <div id="youtube-player"></div>
      <iframe id="sc-player-iframe"
        src="https://w.soundcloud.com/player/?url=&auto_play=false&visual=true&buying=false&sharing=false&download=false&show_comments=false&show_playcount=false&show_user=false&color=%237c3aed"
        style="display:none;width:100%;height:100%;border:none;border-radius:12px;"
        allow="autoplay"></iframe>
      <div class="player-overlay" id="player-overlay"></div>
      <div class="no-track-placeholder" id="no-track-placeholder">
        <span>ğŸµ</span>
        <span data-i18n="waiting_host">Waiting for the host to pick a song...</span>
      </div>
    </div>

    <!-- Now playing -->
    <div class="now-playing" id="now-playing">
      <p class="waiting-msg" id="waiting-msg" data-i18n="waiting_host">Waiting for the host to pick a song...</p>
      <p class="track-name"   id="track-name"   style="display:none"></p>
      <p class="track-artist" id="track-artist" style="display:none"></p>
    </div>

    <!-- Controles (host only) -->
    <div class="controls-bar" id="host-controls" style="display:none">
      <button class="play-pause-btn" id="play-pause-btn" onclick="togglePlayPause()">â–¶</button>
      <div class="seekbar-section">
        <input type="range" id="seekbar" value="0" min="0" max="100" step="0.1">
        <div class="time-row">
          <span id="time-current">0:00</span>
          <span id="time-duration">0:00</span>
        </div>
      </div>
    </div>

    <!-- Volume (todos) -->
    <div class="volume-row">
      <span class="vol-icon">ğŸ”Š</span>
      <input type="range" id="volume-slider" value="100" min="0" max="100">
    </div>

    <!-- Search -->
    <div class="search-section" id="search-section">
      <h4 data-i18n="search_title">ğŸ” Search Music</h4>
      <div class="search-row">
        <input type="text" id="search-input" data-i18n-placeholder="search_placeholder" placeholder="Song name, YouTube or SoundCloud linkâ€¦"
               onkeypress="if(event.key==='Enter') searchYouTube()">
        <button onclick="searchYouTube()" data-i18n="search_btn">Search</button>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>

    <!-- Membros -->
    <div class="members-row" id="members-list"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Autoplay gate -->
<div class="autoplay-gate" id="autoplay-gate">
  <h2 data-i18n="autoplay_title">ğŸµ Ready to listen?</h2>
  <p data-i18n="autoplay_desc">Tap the button to enable audio playback on your device.</p>
  <button onclick="dismissAutoplayGate()" data-i18n="autoplay_btn">Start</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPTS
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// i18n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRANSLATIONS = {
  en: {
    login_subtitle: 'Listen together, anywhere',
    email_placeholder: 'Email', password_placeholder: 'Password',
    email_login: 'Sign In', email_register: 'Register', or_divider: 'or',
    email_fill_fields: 'Please fill in email and password',
    email_pass_min: 'Password must be at least 6 characters',
    login_google: 'Sign in with Google', login_facebook: 'Sign in with Facebook', login_apple: 'Sign in with Apple',
    logout: 'Logout',
    create_room_title: 'ğŸµ Create Room',
    create_room_desc: 'Create a room and share the code with your friends.',
    create_room_btn: 'Create New Room',
    join_room_title: 'ğŸ§ Join Room',
    join_room_desc: 'Enter the 6-character code shared by a friend.',
    room_code_placeholder: 'Ex: AB12CD', join_btn: 'Join', leave_btn: 'â†© Leave',
    waiting_host: 'Waiting for the host to pick a song...',
    search_title: 'ğŸ” Search Music',
    search_placeholder: 'Song name, YouTube or SoundCloud linkâ€¦',
    search_btn: 'Search', searching: 'Searchingâ€¦', no_results: 'No results found.',
    autoplay_title: 'ğŸµ Ready to listen?',
    autoplay_desc: 'Tap the button to enable audio playback on your device.',
    autoplay_btn: 'Start',
    toast_host_only: 'Only the host can choose the song',
    toast_disconnected: 'Disconnected from server',
    toast_error_room: 'Error creating room',
    toast_error_search: 'Search error', toast_yt_error: 'Error loading video',
    toast_code_6: 'Code must be 6 characters',
    you: 'You',
    n_members: (n) => `${n} member${n !== 1 ? 's' : ''}`,
  },
  pt: {
    login_subtitle: 'Escuta juntos, em qualquer lugar',
    email_placeholder: 'Email', password_placeholder: 'Senha',
    email_login: 'Entrar', email_register: 'Cadastrar', or_divider: 'ou',
    email_fill_fields: 'Preencha email e senha',
    email_pass_min: 'Senha deve ter pelo menos 6 caracteres',
    login_google: 'Entrar com Google', login_facebook: 'Entrar com Facebook', login_apple: 'Entrar com Apple',
    logout: 'Sair',
    create_room_title: 'ğŸµ Criar Sala',
    create_room_desc: 'Crie uma sala e compartilhe o cÃ³digo com seus amigos.',
    create_room_btn: 'Criar Nova Sala',
    join_room_title: 'ğŸ§ Entrar numa Sala',
    join_room_desc: 'Digite o cÃ³digo de 6 caracteres compartilhado por um amigo.',
    room_code_placeholder: 'Ex: AB12CD', join_btn: 'Entrar', leave_btn: 'â†© Sair',
    waiting_host: 'Aguardando o host escolher uma mÃºsica...',
    search_title: 'ğŸ” Buscar MÃºsicas',
    search_placeholder: 'MÃºsica, link do YouTube ou SoundCloudâ€¦',
    search_btn: 'Buscar', searching: 'Buscandoâ€¦', no_results: 'Nenhum resultado encontrado.',
    autoplay_title: 'ğŸµ Pronto para ouvir?',
    autoplay_desc: 'Toque no botÃ£o para permitir a reproduÃ§Ã£o de Ã¡udio.',
    autoplay_btn: 'Iniciar',
    toast_host_only: 'Apenas o host pode escolher a mÃºsica',
    toast_disconnected: 'Desconectado do servidor',
    toast_error_room: 'Erro ao criar sala',
    toast_error_search: 'Erro na busca', toast_yt_error: 'Erro ao carregar vÃ­deo',
    toast_code_6: 'CÃ³digo deve ter 6 caracteres',
    you: 'VocÃª',
    n_members: (n) => `${n} membro${n !== 1 ? 's' : ''}`,
  },
  es: {
    login_subtitle: 'Escucha juntos, en cualquier lugar',
    email_placeholder: 'Email', password_placeholder: 'ContraseÃ±a',
    email_login: 'Iniciar sesiÃ³n', email_register: 'Registrarse', or_divider: 'o',
    email_fill_fields: 'Completa email y contraseÃ±a',
    email_pass_min: 'La contraseÃ±a debe tener al menos 6 caracteres',
    login_google: 'Iniciar con Google', login_facebook: 'Iniciar con Facebook', login_apple: 'Iniciar con Apple',
    logout: 'Salir',
    create_room_title: 'ğŸµ Crear Sala',
    create_room_desc: 'Crea una sala y comparte el cÃ³digo con tus amigos.',
    create_room_btn: 'Crear Nueva Sala',
    join_room_title: 'ğŸ§ Unirse a una Sala',
    join_room_desc: 'Ingresa el cÃ³digo de 6 caracteres compartido por un amigo.',
    room_code_placeholder: 'Ej: AB12CD', join_btn: 'Unirse', leave_btn: 'â†© Salir',
    waiting_host: 'Esperando que el host elija una canciÃ³n...',
    search_title: 'ğŸ” Buscar MÃºsica',
    search_placeholder: 'CanciÃ³n, enlace de YouTube o SoundCloudâ€¦',
    search_btn: 'Buscar', searching: 'Buscandoâ€¦', no_results: 'Sin resultados.',
    autoplay_title: 'ğŸµ Â¿Listo para escuchar?',
    autoplay_desc: 'Toca el botÃ³n para habilitar la reproducciÃ³n de audio.',
    autoplay_btn: 'Iniciar',
    toast_host_only: 'Solo el host puede elegir la canciÃ³n',
    toast_disconnected: 'Desconectado del servidor',
    toast_error_room: 'Error al crear sala',
    toast_error_search: 'Error en la bÃºsqueda', toast_yt_error: 'Error al cargar video',
    toast_code_6: 'El cÃ³digo debe tener 6 caracteres',
    you: 'TÃº',
    n_members: (n) => `${n} miembro${n !== 1 ? 's' : ''}`,
  },
};

const _lang = (() => {
  const l = (navigator.language || 'en').toLowerCase();
  if (l.startsWith('pt')) return 'pt';
  if (l.startsWith('es')) return 'es';
  return 'en';
})();

const t = (key, ...args) => {
  const v = (TRANSLATIONS[_lang] || TRANSLATIONS.en)[key] ?? TRANSLATIONS.en[key] ?? key;
  return typeof v === 'function' ? v(...args) : v;
};

function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = t(el.getAttribute('data-i18n')); });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = t(el.getAttribute('data-i18n-placeholder')); });
}
document.addEventListener('DOMContentLoaded', applyI18n);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAfzNGGdcJ-7AkMMwKaIXqK_w6xOxxbkpw",
  authDomain:        "blablabla-79cd2.firebaseapp.com",
  projectId:         "blablabla-79cd2",
  storageBucket:     "blablabla-79cd2.firebasestorage.app",
  messagingSenderId: "914731052244",
  appId:             "1:914731052244:web:763f0f2f456ca8bcfe5f41",
  measurementId:     "G-JX6KQB172L",
};

// â”€â”€â”€ BACKEND URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// URL do backend em produÃ§Ã£o
const BACKEND_URL = 'https://blablabla.live';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser  = null;
let socket       = null;
let ytPlayer     = null;
let ytReady      = false;
let currentRoom  = null;
let isHost       = false;
let ntpOffset    = 0;
let curVideoId   = null;
let duration     = 0;
let seekTimer    = null;
let pendingSync  = null;   // guardado atÃ© o player estar pronto

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();

auth.onAuthStateChanged((user) => {
  currentUser = user;
  if (user) {
    document.getElementById('user-name').textContent  = user.displayName || user.email || t('you');
    if (user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
    showScreen('home');
    connectSocket();
  } else {
    showScreen('login');
    disconnectSocket();
  }
});

let _loginBusy = false;
async function loginWith(provider) {
  if (_loginBusy) return;
  _loginBusy = true;
  let p;
  try {
    switch (provider) {
      case 'google':   p = new firebase.auth.GoogleAuthProvider();          break;
      case 'facebook': p = new firebase.auth.FacebookAuthProvider();       break;
      case 'apple':    p = new firebase.auth.OAuthProvider('apple.com');   break;
      default: _loginBusy = false; return;
    }
    await auth.signInWithPopup(p);
  } catch (err) {
    if (err.code !== 'auth/cancelled-popup-request' && err.code !== 'auth/popup-closed-by-user') {
      showToast(err.message);
    }
  } finally {
    _loginBusy = false;
  }
}

async function emailLogin() {
  const email = document.getElementById('email-input').value.trim();
  const pass  = document.getElementById('password-input').value;
  if (!email || !pass) { showToast(t('email_fill_fields')); return; }
  if (_loginBusy) return;
  _loginBusy = true;
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (err) {
    showToast(err.message || 'Login failed');
  } finally { _loginBusy = false; }
}

async function emailRegister() {
  const email = document.getElementById('email-input').value.trim();
  const pass  = document.getElementById('password-input').value;
  if (!email || !pass) { showToast(t('email_fill_fields')); return; }
  if (pass.length < 6) { showToast(t('email_pass_min')); return; }
  if (_loginBusy) return;
  _loginBusy = true;
  try {
    await auth.createUserWithEmailAndPassword(email, pass);
  } catch (err) {
    showToast(err.message || 'Register failed');
  } finally { _loginBusy = false; }
}

async function logout() {
  leaveRoom();
  await auth.signOut();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOCKET.IO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectSocket() {
  if (socket?.connected) return;
  socket = io(BACKEND_URL);

  socket.on('connect', () => {
    if (currentUser) {
      currentUser.getIdToken().then(token => socket.emit('authenticate', { token }));
    }
  });

  socket.on('authenticated', ({ ntpOffset: off }) => {
    ntpOffset = off || 0;
  });

  socket.on('room_state', ({ room }) => {
    currentRoom = room;
    isHost      = room.hostId === currentUser.uid;
    curVideoId  = room.playbackState?.trackUri || null;
    showScreen('room');
    updateRoomUI();
    if (room.playbackState?.trackUri) syncPlayer(room.playbackState);
  });

  socket.on('playback_update', ({ playbackState }) => {
    if (currentRoom) currentRoom.playbackState = playbackState;
    curVideoId = playbackState.trackUri;
    syncPlayer(playbackState);
    updateNowPlaying(playbackState);
  });

  socket.on('member_joined', ({ uid }) => {
    if (currentRoom && !currentRoom.members.includes(uid)) {
      currentRoom.members.push(uid);
      updateMembersUI();
    }
  });

  socket.on('member_left', ({ uid }) => {
    if (!currentRoom) return;
    if (uid === currentUser.uid) {
      resetRoom();
      showScreen('home');
    } else {
      currentRoom.members = currentRoom.members.filter(id => id !== uid);
      updateMembersUI();
    }
  });

  socket.on('host_changed', ({ newHost }) => {
    if (!currentRoom) return;
    currentRoom.hostId = newHost;
    isHost = newHost === currentUser.uid;
    updateRoomUI();
  });

  socket.on('error', ({ message }) => showToast(message));

  socket.on('disconnect', () => showToast(t('toast_disconnected')));
}

function disconnectSocket() {
  if (socket) { socket.disconnect(); socket = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function createRoom() {
  try {
    const token = await currentUser.getIdToken();
    const res   = await fetch(BACKEND_URL + '/api/rooms', {
      method:  'POST',
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    });
    if (!res.ok) throw new Error(t('toast_error_room'));
    const room = await res.json();
    socket.emit('join_room', { code: room.code });
  } catch (err) {
    showToast(err.message);
  }
}

function joinRoom() {
  const code = document.getElementById('input-room-code').value.trim().toUpperCase();
  if (!code || code.length !== 6) return showToast(t('toast_code_6'));
  socket.emit('join_room', { code });
}

function leaveRoom() {
  if (!socket || !currentRoom) return;
  socket.emit('leave_room');
  resetRoom();
  showScreen('home');
}

function resetRoom() {
  currentRoom = null;
  isHost      = false;
  curVideoId  = null;
  pendingSync = null;
  if (seekTimer) { clearInterval(seekTimer); seekTimer = null; }
  if (ytPlayer && ytReady) ytPlayer.stopVideo();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYER (YouTube + SoundCloud)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ SoundCloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scWidget = null, scReady = false, _scPos = 0, _scDuration = 0, _scCurrentUrl = null;

function isSoundCloudUrl(uri) {
  try { return new URL(uri).hostname.includes('soundcloud.com'); } catch { return false; }
}

function loadSCScript() {
  return new Promise(resolve => {
    if (window.SC) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://w.soundcloud.com/player/api.js';
    s.onload = resolve;
    document.head.appendChild(s);
  });
}

async function initSCWidget() {
  await loadSCScript();
  const iframe = document.getElementById('sc-player-iframe');
  scWidget = SC.Widget(iframe);
  scWidget.bind(SC.Widget.Events.READY, () => { scReady = true; });
  scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, (e) => {
    _scPos      = (e.currentPosition || 0) / 1000;
    _scDuration = (e.soundDuration   || 0) / 1000;
  });
}
initSCWidget();

// â”€â”€ YouTube â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const s = document.createElement('script');
  s.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(s);
})();

window.onYouTubeIframeAPIReady = function () {
  ytPlayer = new YT.Player('youtube-player', {
    playerVars: { controls: 1, rel: 0, modestbranding: 1, playsinline: 1 },
    events: {
      onReady: () => {
        ytReady = true;
        startSeekTimer();
        if (pendingSync) { syncPlayer(pendingSync); pendingSync = null; }
      },
      onStateChange: (e) => {
        duration = ytPlayer.getDuration() || 0;
        if (e.data === YT.PlayerState.PLAYING && currentRoom?.playbackState?.isPlaying) {
          const state = currentRoom.playbackState;
          const now = Date.now() + ntpOffset;
          const elapsed = now - new Date(state.startedAt).getTime();
          const targetSec = Math.max(0, (state.position + elapsed) / 1000);
          const curSec = ytPlayer.getCurrentTime() || 0;
          if (Math.abs(curSec - targetSec) > 0.8) {
            ytPlayer.seekTo(targetSec, true);
          }
        }
      },
      onError: () => showToast(t('toast_yt_error')),
    },
  });
};

function calcTargetSec(state) {
  if (state.isPlaying) {
    const elapsed = Date.now() + ntpOffset - new Date(state.startedAt).getTime();
    return Math.max(0, (state.position + elapsed) / 1000);
  }
  return Math.max(0, state.position / 1000);
}

function showYTPlayer() {
  document.getElementById('youtube-player').style.display   = '';
  document.getElementById('sc-player-iframe').style.display = 'none';
}
function showSCPlayer() {
  document.getElementById('youtube-player').style.display   = 'none';
  document.getElementById('sc-player-iframe').style.display = '';
}

function syncPlayer(state) {
  const uri = state.trackUri;
  if (!uri) return;

  const targetSec = calcTargetSec(state);

  if (isSoundCloudUrl(uri)) {
    if (!scWidget || !scReady) { pendingSync = state; return; }
    showSCPlayer();
    if (_scCurrentUrl !== uri) {
      _scCurrentUrl = uri;
      scWidget.load(uri, {
        auto_play: state.isPlaying,
        buying: false, sharing: false, download: false,
        show_comments: false, visual: true, start_track: 0,
      });
      if (targetSec > 0) setTimeout(() => scWidget.seekTo(targetSec * 1000), 1500);
    } else {
      scWidget.seekTo(targetSec * 1000);
      if (state.isPlaying) scWidget.play(); else scWidget.pause();
    }
  } else {
    if (!ytPlayer || !ytReady) { pendingSync = state; return; }
    showYTPlayer();
    const curVid = ytPlayer.getVideoData?.()?.videoId;
    if (curVid !== uri) {
      ytPlayer.loadVideoById({ videoId: uri, startSeconds: targetSec });
      curVideoId = uri;
    } else {
      ytPlayer.seekTo(targetSec, true);
    }
    if (state.isPlaying) ytPlayer.playVideo();
    else                  ytPlayer.pauseVideo();
  }

  updatePlayPauseBtn(state.isPlaying);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAYBACK CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function togglePlayPause() {
  if (!isHost || !currentRoom?.playbackState) return;
  socket.emit(currentRoom.playbackState.isPlaying ? 'pause' : 'resume');
}

function playTrack(videoId, title, channelTitle) {
  if (!isHost) return showToast(t('toast_host_only'));
  socket.emit('play', { trackUri: videoId, trackName: title, trackArtist: channelTitle });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YOUTUBE SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function searchYouTube() {
  const input = document.getElementById('search-input').value.trim();
  if (!input) return;

  // SoundCloud URL â€” toca direto
  if (isSoundCloudUrl(input)) {
    playTrack(input, 'SoundCloud Track', 'SoundCloud');
    document.getElementById('search-results').innerHTML = '';
    return;
  }

  // YouTube URL â€” extrai video ID
  const vid = extractVideoId(input);
  if (vid) { playTrack(vid, 'VÃ­deo do YouTube', 'YouTube'); return; }

  const el = document.getElementById('search-results');
  el.innerHTML = `<p style="color:rgba(255,255,255,0.35);font-size:14px">${t('searching')}</p>`;

  try {
    const token = await currentUser.getIdToken();
    const res   = await fetch(BACKEND_URL + `/api/youtube/search?q=${encodeURIComponent(input)}`, {
      headers: { 'Authorization': `Bearer ${token}` },
    });
    if (!res.ok) throw new Error(t('toast_error_search'));
    renderResults(await res.json());
  } catch (err) {
    el.innerHTML = `<p style="color:#ec4899;font-size:14px">Erro: ${err.message}</p>`;
  }
}

function extractVideoId(input) {
  try {
    const url = new URL(input);
    if (url.hostname.includes('youtube.com')) return url.searchParams.get('v');
    if (url.hostname === 'youtu.be')          return url.pathname.slice(1).split('?')[0];
  } catch (e) { /* nÃ£o Ã© URL */ }
  return null;
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function renderResults(results) {
  const el = document.getElementById('search-results');
  if (!results.length) {
    el.innerHTML = `<p style="color:rgba(255,255,255,0.35);font-size:14px">${t('no_results')}</p>`;
    return;
  }
  el.innerHTML = results.map(r => `
    <div class="video-card"
         data-id="${escapeHtml(r.videoId)}"
         data-title="${escapeHtml(r.title)}"
         data-channel="${escapeHtml(r.channelTitle)}">
      <img src="${escapeHtml(r.thumbnail)}" alt="${escapeHtml(r.title)}" loading="lazy">
      <div class="video-info">
        <p class="video-title">${escapeHtml(r.title)}</p>
        <p class="video-channel">${escapeHtml(r.channelTitle)}</p>
      </div>
    </div>
  `).join('');
}

// DelegaÃ§Ã£o de clique nos resultados
document.getElementById('search-results').addEventListener('click', (e) => {
  const card = e.target.closest('.video-card');
  if (card) playTrack(card.dataset.id, card.dataset.title, card.dataset.channel);
});

document.getElementById('search-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') searchYouTube();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEEKBAR & VOLUME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('seekbar').addEventListener('input', function () {
  if (!isHost || !duration) return;
  socket.emit('seek', { position: (this.value / 100) * duration * 1000 });
});

document.getElementById('volume-slider').addEventListener('input', function () {
  if (ytPlayer && ytReady) ytPlayer.setVolume(Number(this.value));
});

let _syncCheckCount = 0;
function startSeekTimer() {
  if (seekTimer) clearInterval(seekTimer);
  seekTimer = setInterval(() => {
    const state = currentRoom?.playbackState;
    const uri   = state?.trackUri;
    const isSC  = uri && isSoundCloudUrl(uri);

    let cur = 0, dur = 0;
    if (isSC) {
      cur = _scPos; dur = _scDuration;
    } else {
      if (!ytPlayer || !ytReady) return;
      cur = ytPlayer.getCurrentTime() || 0;
      dur = ytPlayer.getDuration()    || 0;
    }
    duration = dur;
    if (dur > 0) document.getElementById('seekbar').value = (cur / dur) * 100;
    document.getElementById('time-current').textContent  = fmtTime(cur);
    document.getElementById('time-duration').textContent = fmtTime(dur);

    _syncCheckCount++;
    if (_syncCheckCount >= 5 && state?.isPlaying) {
      _syncCheckCount = 0;
      const targetSec = calcTargetSec(state);
      if (Math.abs(cur - targetSec) > 1.0) {
        if (isSC && scWidget && scReady) scWidget.seekTo(targetSec * 1000);
        else if (!isSC && ytPlayer && ytReady) ytPlayer.seekTo(targetSec, true);
      }
    }
  }, 800);
}

function fmtTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${String(s).padStart(2, '0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(`screen-${name}`).classList.add('active');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3200);
}

function updateRoomUI() {
  document.getElementById('room-code').textContent    = currentRoom?.code || '------';
  const n = currentRoom?.members?.length || 0;
  document.getElementById('member-count').textContent = t('n_members', n);

  // Controles do host
  document.getElementById('host-controls').style.display = isHost ? 'flex' : 'none';
  // Overlay bloqueia cliques do nÃ£o-host no player
  document.getElementById('player-overlay').style.display = isHost ? 'none' : 'block';

  if (currentRoom?.playbackState?.trackUri) updateNowPlaying(currentRoom.playbackState);
  updateMembersUI();
}

function updateNowPlaying(state) {
  const hasTrack = !!state?.trackUri;
  document.getElementById('waiting-msg').style.display          = hasTrack ? 'none'  : 'block';
  document.getElementById('track-name').style.display           = hasTrack ? 'block' : 'none';
  document.getElementById('track-artist').style.display         = hasTrack ? 'block' : 'none';
  document.getElementById('no-track-placeholder').style.display = hasTrack ? 'none'  : 'flex';
  if (state?.trackName)   document.getElementById('track-name').textContent   = state.trackName;
  if (state?.trackArtist) document.getElementById('track-artist').textContent = state.trackArtist;
  updatePlayPauseBtn(state?.isPlaying);
}

function updatePlayPauseBtn(playing) {
  document.getElementById('play-pause-btn').textContent = playing ? 'â¸' : 'â–¶';
}

function updateMembersUI() {
  document.getElementById('members-list').innerHTML = (currentRoom?.members || []).map(uid => {
    const isMe   = uid === currentUser.uid;
    const isHostMember = uid === currentRoom.hostId;
    const label  = isMe ? t('you') : uid.slice(0, 8) + 'â€¦';
    return `<span class="member-badge ${isHostMember ? 'is-host' : ''}">${label}${isHostMember ? ' â˜…' : ''}</span>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOPLAY GATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dismissAutoplayGate() {
  document.getElementById('autoplay-gate').classList.remove('show');
  // Tenta reproduzir o vÃ­deo apÃ³s interaÃ§Ã£o do usuÃ¡rio
  if (ytPlayer && ytReady && currentRoom?.playbackState?.isPlaying) {
    ytPlayer.playVideo();
  }
}

// Detecta bloqueio de autoplay quando o player tenta tocar
const origSync = syncPlayer;
window.addEventListener('load', () => {
  // O YT player trata autoplay internamente;
  // se falhar, o browser mostra o overlay nativo.
  // Adicionamos o gate como fallback.
});
</script>
</body>
</html>
